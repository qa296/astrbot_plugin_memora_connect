# åµŒå…¥å‘é‡ç¼“å­˜æ•°æ®åº“ä¿®å¤è®¡åˆ’

## ğŸš¨ é—®é¢˜åˆ†æ

**ç”¨æˆ·åé¦ˆæ—¥å¿—åˆ†æ**:
```
[10:57:53] [Plug] [INFO] [astrbot_plugin_memora_connect.database_migration:107]: æ•°æ®åº“ç»“æ„å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€è¿ç§»
[10:57:53] [Plug] [ERRO] [astrbot_plugin_memora_connect.embedding_cache_manager:142]: åˆ›å»ºç¼“å­˜æ•°æ®åº“å¤±è´¥: no such column: group_id
[10:57:53] [Plug] [ERRO] [astrbot_plugin_memora_connect.embedding_cache_manager:90]: åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: no such column: group_id
[10:57:59] [Plug] [ERRO] [astrbot_plugin_memora_connect.main:971]: çŠ¶æ€åŠ è½½å¼‚å¸¸: no such column: group_id
```

## ğŸ¯ æ ¹æœ¬é—®é¢˜

**æ ¸å¿ƒé—®é¢˜**: åµŒå…¥å‘é‡ç¼“å­˜æ•°æ®åº“ï¼ˆ`embedding_cache.db`ï¼‰ä¸­çš„ `memory_embeddings` è¡¨ç¼ºå°‘ `group_id` å­—æ®µã€‚

**é—®é¢˜åŸå› **:
1. **ä¸»æ•°æ®åº“è¿ç§»æˆåŠŸ**: `memory.db` çš„ `memories` è¡¨å·²ç»æ­£ç¡®æ·»åŠ äº† `group_id` å­—æ®µ
2. **ç¼“å­˜æ•°æ®åº“æœªè¿ç§»**: `embedding_cache.db` çš„ `memory_embeddings` è¡¨æ²¡æœ‰æ‰§è¡Œè¿ç§»
3. **è¿ç§»ç³»ç»Ÿç›²ç‚¹**: æ•°æ®åº“è¿ç§»ç³»ç»Ÿåªæ£€æŸ¥äº†ä¸»æ•°æ®åº“ï¼Œæ²¡æœ‰æ£€æŸ¥åµŒå…¥å‘é‡ç¼“å­˜æ•°æ®åº“

## ğŸ” è¯¦ç»†åˆ†æ

### æ•°æ®åº“æ–‡ä»¶ç»“æ„
- **ä¸»æ•°æ®åº“**: `memory.db` - åŒ…å« `memories` è¡¨ï¼ˆå·²è¿ç§»æˆåŠŸï¼‰
- **ç¼“å­˜æ•°æ®åº“**: `embedding_cache.db` - åŒ…å« `memory_embeddings` è¡¨ï¼ˆæœªè¿ç§»ï¼‰
- **ç¾¤èŠæ•°æ®åº“**: `memory_group_*.db` - åŠ¨æ€åˆ›å»ºçš„ç¾¤èŠä¸“ç”¨æ•°æ®åº“

### è¿ç§»ç³»ç»Ÿé—®é¢˜
å½“å‰çš„ `SmartDatabaseMigration` åªé’ˆå¯¹ä¸»æ•°æ®åº“ï¼ˆ`self.db_path`ï¼‰è¿›è¡Œè¿ç§»ï¼Œä½†åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨ä½¿ç”¨çš„æ˜¯ç‹¬ç«‹çš„æ•°æ®åº“æ–‡ä»¶ã€‚

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: æ‰©å±•æ•°æ®åº“è¿ç§»ç³»ç»Ÿ
ä¿®æ”¹æ•°æ®åº“è¿ç§»ç³»ç»Ÿï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†å¤šä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚

**ä¼˜ç‚¹**:
- ä¸€åŠ³æ°¸é€¸çš„è§£å†³æ–¹æ¡ˆ
- è‡ªåŠ¨åŒ–å¤„ç†æ‰€æœ‰æ•°æ®åº“
- ç¬¦åˆç³»ç»Ÿæ¶æ„

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹æ ¸å¿ƒè¿ç§»é€»è¾‘
- é£é™©è¾ƒé«˜
- æµ‹è¯•å¤æ‚

### æ–¹æ¡ˆB: æ‰‹åŠ¨ä¿®å¤ç¼“å­˜æ•°æ®åº“
ç›´æ¥ä¸ºåµŒå…¥å‘é‡ç¼“å­˜æ•°æ®åº“æ·»åŠ  `group_id` å­—æ®µã€‚

**ä¼˜ç‚¹**:
- å¿«é€Ÿè§£å†³é—®é¢˜
- é£é™©è¾ƒä½
- æ˜“äºéªŒè¯

**ç¼ºç‚¹**:
- ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
- éœ€è¦æ‰‹åŠ¨æ“ä½œ
- å¯èƒ½é—æ¼å…¶ä»–æ•°æ®åº“

### æ–¹æ¡ˆC: åœ¨åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨ä¸­æ·»åŠ è¿ç§»é€»è¾‘
åœ¨ `EmbeddingCacheManager` åˆå§‹åŒ–æ—¶æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“ç»“æ„ã€‚

**ä¼˜ç‚¹**:
- é’ˆå¯¹æ€§å¼º
- è‡ªåŠ¨åŒ–å¤„ç†
- é£é™©å¯æ§

**ç¼ºç‚¹**:
- åˆ†æ•£äº†è¿ç§»é€»è¾‘
- å¯èƒ½é€ æˆé‡å¤ä»£ç 

## ğŸ“‹ æ¨èæ‰§è¡Œè®¡åˆ’ï¼ˆæ–¹æ¡ˆCï¼‰

### ç¬¬ä¸€æ­¥: ä¿®æ”¹ EmbeddingCacheManager åˆå§‹åŒ–
åœ¨ `EmbeddingCacheManager.initialize()` æ–¹æ³•ä¸­æ·»åŠ æ•°æ®åº“ç»“æ„æ£€æŸ¥å’Œä¿®å¤é€»è¾‘ã€‚

### ç¬¬äºŒæ­¥: æ·»åŠ  group_id å­—æ®µ
ä¸º `memory_embeddings` è¡¨æ·»åŠ  `group_id` å­—æ®µå’Œç›¸å…³ç´¢å¼•ã€‚

### ç¬¬ä¸‰æ­¥: éªŒè¯ä¿®å¤ç»“æœ
ç¡®ä¿åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨èƒ½å¤Ÿæ­£å¸¸åˆå§‹åŒ–ã€‚

### ç¬¬å››æ­¥: æµ‹è¯•ç¾¤èŠéš”ç¦»åŠŸèƒ½
éªŒè¯ç¾¤èŠè®°å¿†éš”ç¦»åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

## ğŸ”§ å…·ä½“å®ç°æ­¥éª¤

### 1. ä¿®æ”¹ EmbeddingCacheManager.initialize()
```python
async def initialize(self):
    """åˆå§‹åŒ–åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨"""
    try:
        # ç¡®ä¿æ•°æ®åº“ç»“æ„å­˜åœ¨
        await self._ensure_database_structure()
        
        # æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“ç»“æ„
        await self._check_and_fix_database_structure()
        
        # å…¶ä»–åˆå§‹åŒ–é€»è¾‘...
        
    except Exception as e:
        logger.error(f"åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
        raise
```

### 2. æ·»åŠ æ•°æ®åº“ç»“æ„æ£€æŸ¥å’Œä¿®å¤
```python
async def _check_and_fix_database_structure(self):
    """æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“ç»“æ„"""
    try:
        with sqlite3.connect(self.cache_db_path) as conn:
            cursor = conn.cursor()
            
            # æ£€æŸ¥ memory_embeddings è¡¨æ˜¯å¦å­˜åœ¨
            cursor.execute("""
                SELECT name FROM sqlite_master 
                WHERE type='table' AND name='memory_embeddings'
            """)
            
            if not cursor.fetchone():
                # è¡¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è¡¨
                await self._create_memory_embeddings_table()
                return
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ group_id å­—æ®µ
            cursor.execute("PRAGMA table_info(memory_embeddings)")
            columns = [col[1] for col in cursor.fetchall()]
            
            if "group_id" not in columns:
                # æ·»åŠ  group_id å­—æ®µ
                cursor.execute("""
                    ALTER TABLE memory_embeddings 
                    ADD COLUMN group_id TEXT DEFAULT ''
                """)
                
                # åˆ›å»ºç¾¤èŠéš”ç¦»ç´¢å¼•
                cursor.execute("""
                    CREATE INDEX IF NOT EXISTS idx_embeddings_group_id 
                    ON memory_embeddings(group_id)
                """)
                
                cursor.execute("""
                    CREATE INDEX IF NOT EXISTS idx_embeddings_concept_group 
                    ON memory_embeddings(concept_id, group_id)
                """)
                
                conn.commit()
                logger.info("å·²ä¸º memory_embeddings è¡¨æ·»åŠ  group_id å­—æ®µå’Œç›¸å…³ç´¢å¼•")
            
    except Exception as e:
        logger.error(f"æ£€æŸ¥å’Œä¿®å¤æ•°æ®åº“ç»“æ„å¤±è´¥: {e}")
        raise
```

### 3. åˆ›å»º memory_embeddings è¡¨
```python
async def _create_memory_embeddings_table(self):
    """åˆ›å»º memory_embeddings è¡¨"""
    try:
        with sqlite3.connect(self.cache_db_path) as conn:
            cursor = conn.cursor()
            
            cursor.execute("""
                CREATE TABLE memory_embeddings (
                    memory_id TEXT PRIMARY KEY,
                    concept_id TEXT NOT NULL,
                    embedding BLOB NOT NULL,
                    vector_dimension INTEGER NOT NULL,
                    group_id TEXT DEFAULT "",
                    created_at REAL DEFAULT (strftime('%s', 'now')),
                    last_accessed REAL DEFAULT (strftime('%s', 'now'))
                )
            """)
            
            # åˆ›å»ºç´¢å¼•
            cursor.execute("""
                CREATE INDEX idx_embeddings_group_id ON memory_embeddings(group_id)
            """)
            
            cursor.execute("""
                CREATE INDEX idx_embeddings_concept_group ON memory_embeddings(concept_id, group_id)
            """)
            
            conn.commit()
            logger.info("å·²åˆ›å»º memory_embeddings è¡¨")
            
    except Exception as e:
        logger.error(f"åˆ›å»º memory_embeddings è¡¨å¤±è´¥: {e}")
        raise
```

## ğŸ¯ é¢„æœŸç»“æœ

**æˆåŠŸæ ‡å‡†**:
- åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨èƒ½å¤Ÿæ­£å¸¸åˆå§‹åŒ–
- `memory_embeddings` è¡¨åŒ…å« `group_id` å­—æ®µ
- ç¾¤èŠéš”ç¦»ç´¢å¼•å­˜åœ¨
- ä¸å†å‡ºç° `no such column: group_id` é”™è¯¯
- ç¾¤èŠè®°å¿†éš”ç¦»åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ğŸ”„ æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
- æµ‹è¯• `EmbeddingCacheManager.initialize()` æ–¹æ³•
- æµ‹è¯• `_check_and_fix_database_structure()` æ–¹æ³•
- æµ‹è¯•ç¾¤èŠéš”ç¦»çš„è¯­ä¹‰æœç´¢åŠŸèƒ½

### 2. é›†æˆæµ‹è¯•
- æµ‹è¯•å®Œæ•´çš„è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹
- æµ‹è¯•ç¾¤èŠè®°å¿†çš„å­˜å‚¨å’Œå¬å›
- æµ‹è¯•åµŒå…¥å‘é‡ç¼“å­˜çš„ç®¡ç†

### 3. ç³»ç»Ÿæµ‹è¯•
- åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•ç¾¤èŠéš”ç¦»åŠŸèƒ½
- éªŒè¯ä¸åŒç¾¤èŠé—´çš„è®°å¿†æ•°æ®éš”ç¦»
- ç¡®è®¤æ€§èƒ½å’Œç¨³å®šæ€§

## ğŸ“Š é£é™©è¯„ä¼°

**ä½é£é™©**:
- æ·»åŠ å­—æ®µï¼ˆæœ‰é»˜è®¤å€¼ï¼‰
- åˆ›å»ºç´¢å¼•
- ä¿®æ”¹ç¼“å­˜ç®¡ç†å™¨

**ä¸­ç­‰é£é™©**:
- æ•°æ®åº“ç»“æ„ä¿®æ”¹
- ç¼“å­˜æ•°æ®è¿ç§»

**é«˜é£é™©**:
- åˆ é™¤ç°æœ‰æ•°æ®
- ä¿®æ”¹æ ¸å¿ƒè¿ç§»é€»è¾‘

## ğŸš€ æ‰§è¡Œé¡ºåº

1. **ä¿®æ”¹ EmbeddingCacheManager** - æ·»åŠ æ•°æ®åº“ç»“æ„æ£€æŸ¥å’Œä¿®å¤é€»è¾‘
2. **å®ç°ä¿®å¤æ–¹æ³•** - åˆ›å»º `_check_and_fix_database_structure()` æ–¹æ³•
3. **æµ‹è¯•ä¿®å¤åŠŸèƒ½** - éªŒè¯ä¿®å¤é€»è¾‘çš„æ­£ç¡®æ€§
4. **éƒ¨ç½²ä¿®å¤** - å°†ä¿®å¤åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
5. **ç›‘æ§ç»“æœ** - è§‚å¯Ÿç³»ç»Ÿè¿è¡ŒçŠ¶æ€
6. **éªŒè¯åŠŸèƒ½** - æµ‹è¯•ç¾¤èŠéš”ç¦»åŠŸèƒ½

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: ç¡®ä¿ä¿®å¤ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½
2. **é”™è¯¯å¤„ç†**: æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
3. **æ€§èƒ½è€ƒè™‘**: é¿å…åœ¨æ¯æ¬¡åˆå§‹åŒ–æ—¶éƒ½æ‰§è¡Œæ˜‚è´µçš„æ“ä½œ
4. **æ•°æ®å®‰å…¨**: ç¡®ä¿ä¸ä¼šä¸¢å¤±ç°æœ‰ç¼“å­˜æ•°æ®
5. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿æ‰€æœ‰åœºæ™¯éƒ½è¢«æµ‹è¯•åˆ°

## ğŸ‰ æˆåŠŸæŒ‡æ ‡

**æŠ€æœ¯æŒ‡æ ‡**:
- âœ… åµŒå…¥å‘é‡ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ
- âœ… `memory_embeddings` è¡¨ç»“æ„æ­£ç¡®
- âœ… ç¾¤èŠéš”ç¦»ç´¢å¼•å­˜åœ¨
- âœ… æ— æ•°æ®åº“ç›¸å…³é”™è¯¯

**åŠŸèƒ½æŒ‡æ ‡**:
- âœ… ç¾¤èŠè®°å¿†éš”ç¦»åŠŸèƒ½æ­£å¸¸
- âœ… åµŒå…¥å‘é‡æœç´¢æ”¯æŒç¾¤èŠè¿‡æ»¤
- âœ… ç¼“å­˜ç®¡ç†å™¨æ€§èƒ½ç¨³å®š
- âœ… ç³»ç»Ÿæ•´ä½“è¿è¡Œæ­£å¸¸